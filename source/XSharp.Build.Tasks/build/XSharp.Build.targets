<Project>

    <PropertyGroup>
        <_XSharpBuildTasksAssembly>$(MSBuildThisFileDirectory)XSharp.Build.Tasks.dll</_XSharpBuildTasksAssembly>

        <AssemblyFileExt Condition="'$(AssemblyFileExt)' == ''">.asm</AssemblyFileExt>
        <AssemblyFile Condition="'$(AssemblyFile)' == ''">$(OutputName)$(AssemblyFileExt)</AssemblyFile>

        <AssembleOutputExt Condition="'$(AssembleOutputExt)' == ''">.obj</AssembleOutputExt>
        <AssembleOutput Condition="'$(AssembleOutput)' == ''">$(OutputName)$(AssembleOutputExt)</AssembleOutput>
        <AssemblerOutputFormat Condition="'$(AssemblerOutputFormat)' == ''">Bin</AssemblerOutputFormat>

        <LinkOutput Condition="'$(LinkOutput)' == ''">$(OutputName).$(AssemblerOutputFormat.ToLower())</LinkOutput>

        <LdToolPath Condition="'$(LdToolPath)' == ''">..\tools\</LdToolPath>

        <OutputISO Condition="'$(OutputISO)' == ''">$(OutputName).iso</OutputISO>
    </PropertyGroup>

    <UsingTask TaskName="Xsc" AssemblyFile="$(_XSharpBuildTasksAssembly)" />
    <UsingTask TaskName="XsAssemble" AssemblyFile="$(_XSharpBuildTasksAssembly)" />
    <UsingTask TaskName="Ld" AssemblyFile="$(_XSharpBuildTasksAssembly)" />
    <UsingTask TaskName="MakeISO" AssemblyFile="$(_XSharpBuildTasksAssembly)" />

    <!--
    ================================================================================
                                        Compile

        [IN]
        @(Compile) - the list of X# files to compile.

        [OUT]
        $(AssemblyFile) - the file that results from compiling the .xs files.

    ================================================================================
    -->
    <Target Name="Compile"
            Inputs="@(Compile)"
            Outputs="$(AssemblyFile)">

        <Message Importance="High" Text="Message From CoreCompile" />

        <Xsc InputFiles="@(Compile)"
             OutputFile="$(AssemblyFile)"
             Append="True"
             ToolPath="$(XscToolPath)"
             ToolExe="$(XscToolExe)" />

    </Target>

    <!--
    ================================================================================
                                        Assemble

        [IN]
        $(AssemblyFile) - the file to assemble.

        [OUT]
        $(AssembleOutput) - the file that results from assembling the assembly
                            file.

    ================================================================================
    -->
    <Target Name="Assemble"
            Inputs="$(AssemblyFile)"
            Outputs="$(AssembleOutput)"
            AfterTargets="CoreCompile"
            Condition="$(Assemble) == 'True'">

        <XsAssemble InputFile="$(AssemblyFile)"
                    OutputFile="$(AssembleOutput)"
                    Assembler="NASM"
                    OutputFormat="$(AssemblerOutputFormat)" />
    
    </Target>

    <!--
    ================================================================================
                                       Link

        [IN]
        $(AssembleOutput) - an assembled file.

        [OUT]
        $(LinkOutput) - a linked file.

    ================================================================================
    -->
    <Target Name="Link"
            Inputs="$(AssembleOutput)"
            Outputs="$(LinkOutput)"
            AfterTargets="Assemble">
        
        <Ld InputFile="$(AssembleOutput)"
            OutputFile="$(LinkOutput)"
            TextAddress="0x2000000"
            DataAddress="0x1000000"
            Entry="$(Entry)" />

    </Target>

    <!--
    ================================================================================
                                       DeployISO

        [IN]
        $(LinkOutput) - a linked file.

        [OUT]
        $(OutputISO) - a bootable ISO file.

    ================================================================================
    -->
    <Target Name="DeployISO"
            Inputs="$(LinkOutput)"
            Outputs="$(OutputISO)"
            AfterTargets="Link"
            Condition="'$(OutputType)' == 'Bootable'">

        <MakeIso InputFile="$(LinkOutput)"
                 OutputFile="$(OutputISO)" />

    </Target>

</Project>
