<Project>

    <PropertyGroup>
        <ToolsPath Condition = "'$(ToolsPath)' == ''">$(MSBuildThisFileDirectory)..\tools\</ToolsPath>

        <LdToolPath Condition = "'$(LdToolPath)' == ''">$(ToolsPath)ld\</LdToolPath>
        <LdToolExe Condition = "'$(LdToolExe)' == ''">ld.exe</LdToolExe>

        <MkisofsToolPath Condition = "'$(MkisofsToolPath)' == ''">$(ToolsPath)mkisofs\</MkisofsToolPath>
        <MkisofsToolExe Condition = "'$(MkisofsToolExe)' == ''">mkisofs.exe</MkisofsToolExe>
    </PropertyGroup>

    <PropertyGroup>
        <_XSharpBuildTasksAssembly>$(MSBuildThisFileDirectory)..\tools\win\XSharp.Build.Tasks.dll</_XSharpBuildTasksAssembly>
        <_XSharpBuildTasksAssembly Condition="'$(MSBuildRuntimeType)' == 'Core'">$(MSBuildThisFileDirectory)..\tools\netcoreapp\XSharp.Build.Tasks.dll</_XSharpBuildTasksAssembly>

        <IntermediateOutputPath Condition="'$(IntermediateOutputPath)' == ''">obj\$(Configuration)\</IntermediateOutputPath>

        <AssemblyFileExt Condition="'$(AssemblyFileExt)' == ''">.asm</AssemblyFileExt>
        <AssemblyFile Condition="'$(AssemblyFile)' == ''">$(OutputName)$(AssemblyFileExt)</AssemblyFile>
        <_AssemblyFile>$(IntermediateOutputPath)$(AssemblyFile)</_AssemblyFile>

        <Assemble Condition="'$(Assemble)' == ''">True</Assemble>
        <Assembler Condition="'$(Assembler)' == ''">NASM</Assembler>
        <AssemblerOutputFormat Condition="'$(AssemblerOutputFormat)' == ''">Bin</AssemblerOutputFormat>
        <AssemblerOutputExt Condition="'$(AssemblerOutputExt)' == ''">.bin</AssemblerOutputExt>
        <AssemblerOutput Condition="'$(AssemblerOutput)' == ''">$(OutputName)$(AssemblerOutputExt)</AssemblerOutput>
        <_AssemblerOutput>$(IntermediateOutputPath)$(AssemblerOutput)</_AssemblerOutput>

        <Link Condition="'$(Link)' == '' AND '$(AssemblerOutputFormat)' != 'Bin'">True</Link>
        <Link Condition="'$(Link)' == ''">False</Link>
        <LinkOutput Condition="'$(LinkOutput)' == ''">$(OutputName).bin</LinkOutput>
        <_LinkOutput>$(IntermediateOutputPath)$(LinkOutput)</_LinkOutput>

        <BinaryOutput>$(_AssemblerOutput)</BinaryOutput>
        <BinaryOutput Condition="'$(Link)' == 'True'">$(_LinkOutput)</BinaryOutput>
        <BinName Condition="'$(BinName)' == ''">$([System.IO.Path]::GetFileName('$(BinaryOutput)'))</BinName>

        <ISOLINUX Condition="'$(ISOLINUX)' == ''">$(ToolsPath)isolinux\</ISOLINUX>
        <OutputIsoFileName Condition="'$(OutputIsoFileName)' == ''">$(OutputName).iso</OutputIsoFileName>
        <OutputIso Condition="'$(OutputIso)' == ''">$(IntermediateOutputPath)$(OutputIsoFileName)</OutputIso>
        
        <IntermediateIsoDirectory Condition="'$(IntermediateIsoDirectory)' == ''">$(IntermediateOutputPath)ISO\</IntermediateIsoDirectory>

        <LaunchType Condition="'$(LaunchType)' == ''">Bochs</LaunchType>
        <LaunchConfigurationFile Condition="'$(LaunchConfigurationFile)' == ''">$(IntermediateOutputPath)$(OutputName).bxrc</LaunchConfigurationFile>
    
</PropertyGroup>

    <UsingTask TaskName="Xsc" AssemblyFile="$(_XSharpBuildTasksAssembly)" />
    <UsingTask TaskName="XsAssemble" AssemblyFile="$(_XSharpBuildTasksAssembly)" />
    <UsingTask TaskName="Ld" AssemblyFile="$(_XSharpBuildTasksAssembly)" />
    <UsingTask TaskName="CreateSyslinuxConfig" AssemblyFile="$(_XSharpBuildTasksAssembly)" />
    <UsingTask TaskName="MakeISO" AssemblyFile="$(_XSharpBuildTasksAssembly)" />
    <UsingTask TaskName="Launch" AssemblyFile="$(_XSharpBuildTasksAssembly)" />

    <!--
    ================================================================================
                                     PrepareForBuild

        Creates the needed directories used by build targets.

    ================================================================================
    -->
    <Target Name="PrepareForBuild">
        
        <MakeDir Directories="$(IntermediateOutputPath)"
                 Condition="!Exists('$(IntermediateOutputPath)')" />
        
    </Target>
    
    <!--
    ================================================================================
                                        Compile

        [IN]
        @(Compile) - the list of X# files to compile.

        [OUT]
        $(_AssemblyFile) - the file that results from compiling the .xs files.

    ================================================================================
    -->
    <Target Name="Compile"
            Inputs="@(Compile)"
            Outputs="$(_AssemblyFile)">

        <Xsc InputFiles="@(Compile)"
             OutputFile="$(_AssemblyFile)"
             Append="True"
             ToolPath="$(XscToolPath)"
             ToolExe="$(XscToolExe)" />

    </Target>

    <!--
    ================================================================================
                                        Assemble

        [IN]
        $(_AssemblyFile) - the file to assemble.

        [OUT]
        $(_AssemblerOutput) - the file that results from assembling the assembly
                              file.

    ================================================================================
    -->
    <Target Name="Assemble"
            Inputs="$(_AssemblyFile)"
            Outputs="$(_AssemblerOutput)"
            Condition="'$(Assemble)' == 'True'">

        <XsAssemble InputFile="$(_AssemblyFile)"
                    OutputFile="$(_AssemblerOutput)"
                    Assembler="$(Assembler)"
                    OutputFormat="$(AssemblerOutputFormat)"
                    ToolsPath="$(ToolsPath)"/>

    </Target>

    <!--
    ================================================================================
                                       Link

        [IN]
        $(_AssemblerOutput) - an assembled file.

        [OUT]
        $(_LinkOutput) - a linked file.

    ================================================================================
    -->
    <Target Name="Link"
            Inputs="$(_AssemblerOutput)"
            Outputs="$(_LinkOutput)"
            Condition="'$(Link)' == 'True'">

        <Ld InputFiles="$(_AssemblerOutput)"
            OutputFile="$(_LinkOutput)"
            TextAddress="0x2000000"
            DataAddress="0x1000000"
            Entry="$(Entry)"
            ToolPath="$(LdToolPath)"
            ToolExe="$(LdToolExe)" />

    </Target>

    <!--
    ================================================================================
                                      PrepareForRun
    ================================================================================
    -->
    <Target Name="PrepareForRun" DependsOnTargets="DeployISO" />

    <!--
    ================================================================================
                                       DeployISO

        [IN]
        $(BinaryOutput) - a binary file.

        [OUT]
        $(OutputIso) - a bootable ISO file.
        $(IntermediateIsoDirectory)syslinux.cfg - the syslinux configuration
                                                  file.

    ================================================================================
    -->
    <Target Name="DeployISO"
            Inputs="$(BinaryOutput)"
            Outputs="$(OutputIso);$(IntermediateIsoDirectory)syslinux.cfg"
            Condition="'$(OutputType)' == 'Bootable'">

        <ItemGroup>
            <_ISOLINUX Include="$(ISOLINUX)**" />
        </ItemGroup>

        <MakeDir Directories="$(IntermediateIsoDirectory)" />
        <Copy SourceFiles="@(_ISOLINUX);$(BinaryOutput)"
              DestinationFolder="$(IntermediateIsoDirectory)" />

        <CreateSyslinuxConfig IsoDirectory="$(IntermediateIsoDirectory)"
                              BinName="$(BinName)" />

        <MakeIso IsoDirectory="$(IntermediateIsoDirectory)"
                 OutputFile="$(OutputIso)"
                 ToolPath="$(MkisofsToolPath)"
                 ToolExe="$(MkisofsToolExe)" />

    </Target>

    <!--
    ================================================================================
                                           Run
    ================================================================================
    -->
    <Target Name="Run"
            DependsOnTargets="DeployISO">

        <Error Text="Output type '$(OutputType)' cannot be run!"
               Condition="'$(OutputType)' != 'Application' AND '$(OutputType)' != 'Bootable'" />

        <Exec Command="$(BinaryOutput)"
              Condition="'$(OutputType)' == 'Application'" />
        
        <Launch LaunchType="$(LaunchType)"
                ISO="$(OutputIso)"
                ConfigurationFile="$(LaunchConfigurationFile)"
                Condition="'$(OutputType)' == 'Bootable'"/>
        
    </Target>

</Project>
